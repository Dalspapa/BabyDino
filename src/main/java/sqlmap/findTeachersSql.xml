<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dino.findTeachers">

	<!-- 선생님 카드 리스트 -->
	<select id="teacherList" resultType="dino.findteachers.model.FindTeacherJoinDto">
		  	SELECT 
                 m.idx
                ,m.name
                ,(TO_CHAR(SYSDATE ,'yyyy') - TO_CHAR (birth, 'yyyy')) as age
                ,m.gender
                ,t.idx as teacher_idx
                ,t.t_care_type
                ,t.t_cost
                ,t.t_introduce
                ,ci.c_imgpath
            FROM 
                d_teachercard t
            LEFT JOIN 
                d_member m ON m.idx = t.d_member_idx
            LEFT JOIN 
                d_common_img ci ON ci.d_member_idx = t.idx
            WHERE
                t.d_member_idx = m.idx
	</select>
	
	<!-- 아이카드 선택하기 -->
	<select id="pickKidsCard" parameterType="Integer" resultType="dino.dto.KidDto">
	SELECT
			a.idx,
			a.k_name, 
			a.k_gender, 
			a.k_birth,
            b.age
	FROM 
			d_kidcard a, 
            (SELECT
            idx as xidx,
			(TO_CHAR(SYSDATE ,'yyyy') -
            TO_CHAR (k_birth, 'yyyy')) as age
            FROM 
                d_kidcard
            WHERE 
                d_member_idx = #{idx}) b
    WHERE 
        a.idx = b.xidx
	</select>
	
	<!-- 이미지 인서트 -->
	<insert id="kSetImg" parameterType="dino.dto.Common_ImgDto">
		INSERT INTO
			d_common_img
		VALUES(
			d_common_img_idx.nextval,
			#{c_imgpath},
			#{d_member_idx},
			1,
			#{ref_idx}
		)
	</insert>
	
	<!-- 이미지 출력 -->
	<select id="getImg" parameterType="Integer" resultType="dino.dto.Common_ImgDto" >
		SELECT 
				dt.*
     			, dci.c_imgpath
		FROM 
				d_teachercard dt 
		LEFT JOIN 
				d_common_img dci 
		ON 
				dt.d_member_idx = dci.d_member_idx
		WHERE 
				dt.idx = #{d_teachercard_idx}
		AND 
				dci.category_idx = 2;
	</select>
	
	
	<!-- 아이 주소카드 선택하기 -->
	<select id="pickAddr" parameterType="Integer" resultType="dino.dto.MemberDto">
	SELECT
    	idx,
    	addr1,
    	addr2,
    	addr3
	FROM
    	d_member
	WHERE
    	idx = #{idx}
	</select>
	
	<!-- 아이카드 만들기 --> 
	<insert id="k_makeCard" parameterType="dino.dto.KidDto">
		<selectKey keyProperty="idx" resultType="int" order="BEFORE">
			SELECT  d_kidcard_idx.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO 
        	d_kidcard
        VALUES(
	d_kidcard_idx.nextval,
	#{d_member_idx},
	#{k_name},
	#{k_gender},
	#{k_birth},
	#{k_introduce},
	#{k_care_type},
	#{k_tendency},
	#{teacher_type},
	#{k_require}
        )
	</insert>
	
	<!-- 아이 카드로 예약  -->
	<insert id="k_reserve" parameterType="dino.dto.ReserveDto">
	INSERT INTO
	    	 d_reserve
		VALUES(
		    D_RESERVE_IDX.nextval,
		    #{member_p_idx},
		    #{kid_idx},
		    to_date(#{start_date}, 'yyyy-mm-dd hh24'),
		    to_date(#{end_date}, 'yyyy-mm-dd hh24'),
		    #{cost},
		    1,
		    null,
		    null,
		    null
	)
	</insert>
	
	<!-- 선생님 상세정보 출력 -->
	<select id="teacherInfo" parameterType="Integer" resultType="dino.findteachers.model.FindTeacherJoinDto">
		SELECT 
			  t.t_cost
			, t.job
			, t.t_introduce
			, t.kid_type
			, t.t_care_type
			, t.career_experience
			, t.cctvagree
			, m.name
			, m.birth
			, m.gender
			, m.addr2
			, i.c_imgpath
		FROM
			d_teachercard t
		LEFT JOIN 
			d_member m ON m.idx = t.d_member_idx
		LEFT JOIN 
			d_common_img i on i.ref_idx = t.idx
		where 
			t.idx = #{idx}
	</select>
	
	<!-- 선생님 상세 정보 리뷰 출력 -->
	<select id="teacherReviewList" resultType="dino.dto.ReviewDto">
		SELECT
			 idx
	     	 , d_reserve_idx
	     	 , d_member_idx
	     	 , star
	     	 , r_writedate
	     	 , r_content
		FROM 
			d_review 
		WHERE 
			d_member_idx = #{d_member_idx}
	</select>
	
	
</mapper>